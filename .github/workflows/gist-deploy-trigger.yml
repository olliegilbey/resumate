name: Gist Update Deploy Trigger

# Runs every hour to check if gist has been updated
on:
  schedule:
    - cron: '0 * * * *'  # Every hour at minute 0
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  check-gist-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Fetch gist metadata
        id: gist
        run: |
          # Use gist ID from secrets
          GIST_ID="${{ secrets.RESUME_DATA_GIST_ID }}"

          # Fetch gist metadata from GitHub API
          RESPONSE=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/gists/${GIST_ID}")

          UPDATED_AT=$(echo "$RESPONSE" | jq -r '.updated_at // empty')

          # Guard against null/empty (API error, rate limit, etc)
          if [ -z "$UPDATED_AT" ] || [ "$UPDATED_AT" = "null" ]; then
            echo "⚠️ Could not fetch gist timestamp - skipping deploy check"
            echo "API response: $(echo "$RESPONSE" | jq -r '.message // "no error message"')"
            echo "valid_timestamp=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Gist last updated: $UPDATED_AT"
          echo "updated_at=$UPDATED_AT" >> $GITHUB_OUTPUT
          echo "valid_timestamp=true" >> $GITHUB_OUTPUT

      - name: Validate gist with schema
        id: validate
        if: steps.gist.outputs.valid_timestamp == 'true'
        run: |
          # Fetch the gist content using secret
          GIST_ID="${{ secrets.RESUME_DATA_GIST_ID }}"
          # Extract username from repository (format: owner/repo)
          USERNAME="${{ github.repository_owner }}"
          GIST_URL="https://gist.githubusercontent.com/${USERNAME}/${GIST_ID}/raw/resume-data.json"

          echo "Fetching gist content for validation..."
          curl -s "$GIST_URL" -o /tmp/gist-data.json

          # Validate JSON syntax first
          if ! jq empty /tmp/gist-data.json 2>/dev/null; then
            echo "❌ JSON syntax is invalid!"
            echo "valid=false" >> $GITHUB_OUTPUT
            ERROR_MSG=$(jq empty /tmp/gist-data.json 2>&1 || true)
            echo "error_msg=$ERROR_MSG" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "✅ JSON syntax valid"

          # Validate against schema
          echo "Validating against schema..."
          if bun scripts/validate-compendium.mjs /tmp/gist-data.json 2>&1 | tee /tmp/validation.log; then
            echo "✅ Schema validation passed"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Schema validation failed!"
            echo "valid=false" >> $GITHUB_OUTPUT
            ERROR_MSG=$(cat /tmp/validation.log)
            echo "error_msg<<EOF" >> $GITHUB_OUTPUT
            echo "$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Get last Vercel deployment time
        id: vercel
        if: steps.validate.outputs.valid == 'true'
        run: |
          echo "Fetching last Vercel deployment..."
          VERCEL_RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            "https://api.vercel.com/v6/deployments?projectId=${{ secrets.VERCEL_PROJECT_ID }}&limit=1&state=READY")

          LAST_DEPLOY=$(echo "$VERCEL_RESPONSE" | jq -r '.deployments[0].created')

          if [ "$LAST_DEPLOY" = "null" ] || [ -z "$LAST_DEPLOY" ]; then
            echo "No previous deployment found, will trigger deploy"
            LAST_DEPLOY=0
          else
            # Convert from milliseconds to ISO 8601 for comparison
            LAST_DEPLOY_ISO=$(date -u -d @$((LAST_DEPLOY / 1000)) +"%Y-%m-%dT%H:%M:%SZ" 2>/dev/null || date -u -r $((LAST_DEPLOY / 1000)) +"%Y-%m-%dT%H:%M:%SZ")
            echo "Last Vercel deployment: $LAST_DEPLOY_ISO"
            LAST_DEPLOY=$LAST_DEPLOY_ISO
          fi

          echo "last_deploy=$LAST_DEPLOY" >> $GITHUB_OUTPUT

      - name: Check if gist changed since last deploy
        id: check
        if: steps.validate.outputs.valid == 'true'
        run: |
          GIST_UPDATE="${{ steps.gist.outputs.updated_at }}"
          LAST_DEPLOY="${{ steps.vercel.outputs.last_deploy }}"

          echo "Gist updated: $GIST_UPDATE"
          echo "Last deploy: $LAST_DEPLOY"

          if [ "$LAST_DEPLOY" = "0" ] || [[ "$GIST_UPDATE" > "$LAST_DEPLOY" ]]; then
            echo "Gist has been updated since last deploy! Triggering deploy..."
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected, skipping deploy."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Vercel deployment
        if: steps.check.outputs.changed == 'true'
        run: |
          echo "Triggering Vercel deploy hook..."
          HTTP_STATUS=$(curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}" \
            -o /dev/null -w "%{http_code}" -s)

          if [ "$HTTP_STATUS" -eq 201 ] || [ "$HTTP_STATUS" -eq 200 ]; then
            echo "✅ Deploy triggered successfully (HTTP $HTTP_STATUS)"
          else
            echo "❌ Deploy trigger failed (HTTP $HTTP_STATUS)"
            exit 1
          fi

      - name: Notify on validation failure
        if: steps.validate.outputs.valid == 'false'
        run: |
          echo "::error title=Invalid Resume Data in Gist::Resume data gist failed validation and deploy was skipped."
          echo ""
          echo "Validation errors:"
          echo "${{ steps.validate.outputs.error_msg }}"
          echo ""
          echo "Please fix the gist data and it will be automatically deployed on the next hourly check."
          exit 1
