#!/usr/bin/env bash
#
# Optimized Pre-commit Hook for Resumate
# Fail-fast ordering: Secrets â†’ Lint â†’ Conditional rebuilds â†’ Tests
#
# Philosophy: Heavy by design (10-60s) - Last defense before public repo
# Fast path (no rebuilds): ~10-15s
# WASM rebuild path: ~45-60s
#
# Skip only in emergency: git commit --no-verify

set -e  # Exit on first error

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track timing
START_TIME=$(date +%s)

# Source build limits from justfile (single source of truth)
WASM_MAX_RAW_MB=$(just --evaluate wasm_max_raw_mb)
WASM_MAX_GZIP_MB=$(just --evaluate wasm_max_gzip_mb)
PRECOMMIT_MAX_DURATION=$(just --evaluate precommit_max_duration)

echo ""
printf "${BLUE}ğŸ”’ Pre-commit: Fail-fast validation${NC}\n"
echo ""

# ============================================
# PHASE 1: SECRET SCANNING (~5s)
# Fail immediately if secrets/PII detected
# ============================================
printf "${BLUE}â†’ Phase 1/7: Secret scanning (gitleaks, ripsecrets, trufflehog)${NC}\n"

# 1.1 Gitleaks (filesystem scan, uses .gitleaks.toml)
# Use 'detect --no-git' to scan all current files (no git history)
# Catches secrets in: committed files, staged, unstaged, untracked
GITLEAKS_OUTPUT=$(gitleaks detect --no-banner --verbose --no-git 2>&1)
if ! echo "$GITLEAKS_OUTPUT" | grep -q "no leaks found"; then
  printf "${RED}âŒ Gitleaks found secrets or PII in repository!${NC}\n"
  echo "$GITLEAKS_OUTPUT"
  printf "${YELLOW}Fix and retry. Add to .gitignore or .gitleaks.toml allowlist if false positive.${NC}\n"
  exit 1
fi
printf "${GREEN}  âœ“${NC} Gitleaks: 0 secrets (all files)"

# 1.2 Ripsecrets (filesystem scan)
if ! ripsecrets --strict-ignore . 2>&1; then
  printf "${RED}âŒ Ripsecrets found secrets!${NC}\n"
  exit 1
fi
printf "${GREEN}  âœ“${NC} Ripsecrets: 0 secrets"

# 1.3 Trufflehog (deep scan on staged files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [ -n "$STAGED_FILES" ]; then
  TRUFFLEHOG_OUTPUT=$(echo "$STAGED_FILES" | xargs trufflehog filesystem --no-update --only-verified --json 2>&1 || true)
  # Check if any JSON objects were output (findings)
  if echo "$TRUFFLEHOG_OUTPUT" | grep -q '"DetectorType"'; then
    printf "${RED}âŒ Trufflehog found verified secrets!${NC}\n"
    echo "$TRUFFLEHOG_OUTPUT" | grep '"DetectorType"'
    exit 1
  fi
  printf "${GREEN}  âœ“${NC} Trufflehog: 0 verified secrets"
fi

printf "${GREEN}âœ… Phase 1 complete: No secrets detected${NC}\n"
echo ""

# ============================================
# PHASE 2: LINT + TYPECHECK (~5-10s)
# Fast validation before expensive operations
# ============================================
printf "${BLUE}â†’ Phase 2/7: Lint & typecheck${NC}\n"

# Check which files are staged
TS_STAGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)
RS_STAGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.rs$' || true)

# 2.1 TypeScript linting (if TS files changed)
if [ -n "$TS_STAGED" ]; then
  printf "${YELLOW}  â†’ ESLint (TS files changed)${NC}\n"
  if ! bun x eslint --fix $TS_STAGED 2>&1; then
    printf "${RED}âŒ ESLint failed${NC}\n"
    exit 1
  fi
  printf "${GREEN}  âœ“${NC} ESLint passed"

  # Stage fixed files
  git add $TS_STAGED
fi

# 2.2 TypeScript typecheck (if TS files changed)
if [ -n "$TS_STAGED" ]; then
  printf "${YELLOW}  â†’ TypeScript typecheck${NC}\n"
  if ! bun x tsc --noEmit 2>&1; then
    printf "${RED}âŒ TypeScript typecheck failed${NC}\n"
    exit 1
  fi
  printf "${GREEN}  âœ“${NC} TypeScript typecheck passed"
fi

# 2.3 Rust formatting (if Rust files changed)
if [ -n "$RS_STAGED" ]; then
  printf "${YELLOW}  â†’ Rust formatting${NC}\n"
  if ! cargo fmt --check --quiet 2>&1; then
    printf "${YELLOW}  â†’ Auto-formatting Rust code${NC}\n"
    cargo fmt --all
    git add $RS_STAGED
  fi
  printf "${GREEN}  âœ“${NC} Rust formatted"
fi

# 2.4 Clippy (if Rust files changed)
if [ -n "$RS_STAGED" ]; then
  printf "${YELLOW}  â†’ Clippy${NC}\n"
  if ! cargo clippy --all-targets --quiet -- -D warnings 2>&1; then
    printf "${RED}âŒ Clippy found warnings${NC}\n"
    exit 1
  fi
  printf "${GREEN}  âœ“${NC} Clippy passed (zero warnings)"
fi

printf "${GREEN}âœ… Phase 2 complete: Lint & typecheck passed${NC}\n"
echo ""

# ============================================
# PHASE 3: WASM REBUILD (~1-45s, conditional)
# Only rebuild if WASM sources changed
# ============================================
printf "${BLUE}â†’ Phase 3/7: WASM freshness check${NC}\n"

WASM_REBUILT=false

# Check if WASM sources are staged
WASM_SOURCES=(
  "crates/resume-wasm"
  "crates/resume-typst"
  "crates/resume-core"
  "crates/shared-types"
  "typst/templates"
  "typst/fonts"
)

wasm_staged=false
for source in "${WASM_SOURCES[@]}"; do
  if git diff --cached --name-only | grep -q "^${source}/"; then
    wasm_staged=true
    break
  fi
done

if [ "$wasm_staged" = true ]; then
  printf "${YELLOW}  â†’ WASM sources changed - checking freshness${NC}\n"

  # Run check-wasm.sh --fresh (handles rebuild + staging)
  if ./scripts/check-wasm.sh --fresh; then
    WASM_REBUILT=true
    printf "${GREEN}  âœ“${NC} WASM rebuilt and staged"
  else
    printf "${RED}âŒ WASM rebuild failed${NC}\n"
    exit 1
  fi
else
  printf "${GREEN}  âœ“${NC} WASM sources unchanged (skipped)"
fi

if [ "$WASM_REBUILT" = true ]; then
  printf "${GREEN}âœ… Phase 3 complete: WASM rebuilt${NC}\n"
else
  printf "${GREEN}âœ… Phase 3 complete: WASM up-to-date${NC}\n"
fi
echo ""

# ============================================
# PHASE 4: BUNDLE SIZE CHECK (<1s)
# Enforce WASM binary size limits (from justfile)
# ============================================
printf "${BLUE}â†’ Phase 4/7: Bundle size validation${NC}\n"

if bash ./scripts/check-bundle-size.sh "$WASM_MAX_RAW_MB" "$WASM_MAX_GZIP_MB"; then
  printf "${GREEN}âœ… Phase 4 complete: Bundle size within limits${NC}\n"
else
  printf "${RED}âŒ Bundle size check failed${NC}\n"
  exit 1
fi
echo ""

# ============================================
# PHASE 5: WASM TESTS (~10s, conditional)
# Only run if WASM was rebuilt in this commit
# ============================================
printf "${BLUE}â†’ Phase 5/7: WASM-dependent tests${NC}\n"

if [ "$WASM_REBUILT" = true ]; then
  printf "${YELLOW}  â†’ Running WASM-dependent Rust tests${NC}\n"

  # Tests that depend on WASM: pdf_validation, pdf_permutation
  if ! cargo test --test pdf_validation --test pdf_permutation --quiet 2>&1; then
    printf "${RED}âŒ WASM tests failed${NC}\n"
    exit 1
  fi
  printf "${GREEN}  âœ“${NC} WASM tests passed"
else
  printf "${GREEN}  âœ“${NC} WASM unchanged (tests skipped)"
fi

if [ "$WASM_REBUILT" = true ]; then
  printf "${GREEN}âœ… Phase 5 complete: WASM tests passed${NC}\n"
else
  printf "${GREEN}âœ… Phase 5 complete: WASM tests skipped${NC}\n"
fi
echo ""

# ============================================
# PHASE 6: TYPE SYNC (~5s, conditional)
# Only regenerate if shared-types changed
# ============================================
printf "${BLUE}â†’ Phase 6/7: Type synchronization${NC}\n"

if echo "$RS_STAGED" | grep -q "crates/shared-types/"; then
  printf "${YELLOW}  â†’ shared-types changed - regenerating schema + TS types${NC}\n"

  # Generate JSON Schema from Rust
  if ! cargo run --bin generate_schema -p shared-types --quiet 2>&1; then
    printf "${RED}âŒ Schema generation failed${NC}\n"
    exit 1
  fi

  # Generate TS types from schema
  if ! bun types:gen 2>&1; then
    printf "${RED}âŒ TS type generation failed${NC}\n"
    exit 1
  fi

  # Stage generated files
  git add schemas/resume.schema.json lib/types/generated-resume.ts

  printf "${GREEN}  âœ“${NC} Types synchronized and staged"
else
  printf "${GREEN}  âœ“${NC} shared-types unchanged (skipped)"
fi

printf "${GREEN}âœ… Phase 6 complete: Types synchronized${NC}\n"
echo ""

# ============================================
# PHASE 7: RUST TESTS (conditional)
# Only run if Rust files changed (not WASM-only)
# ============================================
printf "${BLUE}â†’ Phase 7/7: Rust test suite${NC}\n"

if [ -n "$RS_STAGED" ]; then
  printf "${YELLOW}  â†’ Running full Rust test suite${NC}\n"

  if ! cargo test --all --quiet 2>&1; then
    printf "${RED}âŒ Rust tests failed${NC}\n"
    exit 1
  fi
  printf "${GREEN}  âœ“${NC} Rust tests passed"
else
  printf "${GREEN}  âœ“${NC} No Rust files changed (skipped)"
fi

# TypeScript tests (if TS or shared-types changed)
if [ -n "$TS_STAGED" ] || echo "$RS_STAGED" | grep -q "crates/shared-types/"; then
  printf "${YELLOW}  â†’ Running TypeScript tests${NC}\n"

  if ! bun run test --run --reporter=dot 2>&1; then
    printf "${RED}âŒ TypeScript tests failed${NC}\n"
    exit 1
  fi
  printf "${GREEN}  âœ“${NC} TypeScript tests passed"
fi

# Data validation (if data files changed)
DATA_STAGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '^data/.*\.json$' || true)
if [ -n "$DATA_STAGED" ]; then
  printf "${YELLOW}  â†’ Validating data files${NC}\n"

  for file in $DATA_STAGED; do
    if ! node scripts/validate-compendium.mjs "$file" 2>&1; then
      printf "${RED}âŒ Data validation failed: $file${NC}\n"
      exit 1
    fi
  done
  printf "${GREEN}  âœ“${NC} Data validation passed"
fi

# Doc verification (if docs changed)
DOCS_STAGED=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md)$' || true)
if [ -n "$DOCS_STAGED" ]; then
  printf "${YELLOW}  â†’ Verifying documentation${NC}\n"

  if ! bash scripts/verify-docs.sh 2>&1; then
    printf "${RED}âŒ Documentation verification failed${NC}\n"
    exit 1
  fi
  printf "${GREEN}  âœ“${NC} Documentation verified"
fi

printf "${GREEN}âœ… Phase 7 complete: All tests passed${NC}\n"
echo ""

# ============================================
# TIMING ENFORCEMENT (from justfile)
# ============================================
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

# Enforce timing SLO (sourced from justfile)
# Based on testing: Fast path=2s, WASM rebuild=39s, threshold=70s
if (( DURATION > PRECOMMIT_MAX_DURATION )); then
  printf "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
  printf "${RED}âŒ Pre-commit exceeded timing SLO!${NC}\n"
  printf "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
  echo ""
  echo "  Duration: ${DURATION}s (limit: ${PRECOMMIT_MAX_DURATION}s)"
  echo ""
  echo "  Investigate performance regression:"
  echo "    - Check for excessive WASM rebuild time"
  echo "    - Profile secret scanning (should be <5s)"
  echo "    - Check test suite duration"
  echo ""
  echo "  To adjust limit: Edit justfile precommit_max_duration"
  echo "  To bypass (emergency only): git commit --no-verify"
  exit 1
fi

# ============================================
# SUMMARY
# ============================================
printf "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
printf "${GREEN}âœ… All pre-commit checks passed!${NC}\n"
printf "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n"
echo ""
echo "  Duration: ${DURATION}s"
echo ""
echo "  Phases:"
echo "    âœ“ Secret scanning"
echo "    âœ“ Lint & typecheck"
if [ "$WASM_REBUILT" = true ]; then
  echo "    âœ“ WASM rebuild"
else
  echo "    âœ“ WASM check"
fi
echo "    âœ“ Bundle size"
echo "    âœ“ Tests"
echo "    âœ“ Type sync"
echo "    âœ“ Validation"
echo ""
